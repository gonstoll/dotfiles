#!/usr/bin/env bash

source "$XDG_CONFIG_HOME/zsh/functions"

new_notes_dir="new"
flushed_notes_dir="_flushed"
classified_notes_dir="notes"
vault_name="gonzalo_notes"
OBSIDIAN_CONFIG="${XDG_CONFIG_HOME}/obsidian/"
OBSIDIAN_NOTES="${HOME}/notes/obsidian/${vault_name}"

function run_help() {

    cat <<EOT
Obisidan cli

Usage: $(basename "$0") [OPTION]... [NOTE_TITLE]

When run without arguments, opens an interactive file browser to select existing notes.
When given a NOTE_TITLE, creates a new note with that title.

Options:
    -h, --help            Print this help text
    -f, --flush           Start the flush workflow. This goes through all your new notes, where you can choose to keep the current note (<leader>ok) or discard it (<leader>od).
    -c, --class           Classifies all your flushed notes. Goes through all your flushed notes, and assignes them to their respective dirs based on their type frontmatter.
    -C, --create-valut    Creates a new vault with all dotfiles configurations and plugins

Examples:
    $(basename "$0")                    # Browse existing notes with fzf
    $(basename "$0") "My new note"      # Create note titled "My new note"
    $(basename "$0") -f                 # Start flush workflow

EOT

}

function switch_to() {
    tmux-sessionizer "$OBSIDIAN_NOTES"
    tmux selectw -t "$vault_name:1"
    
    # Check if nvim is running in the target pane
    if tmux display-message -t "$vault_name:1" -p '#{pane_current_command}' | grep -q "^nvim$"; then
        # Nvim is running - use :tabnew to open in new tab
        tmux send-keys -t "$vault_name" Escape
        tmux send-keys -t "$vault_name" ":tabnew $1" C-m
    else
        # Nvim is not running - start nvim with the file
        tmux send-keys -t "$vault_name" "nvim $1" C-m
    fi
}

function create_vault() {
    vault_name="$1"
    mkdir -p "${OBSIDIAN_NOTES}/${vault_name}/.obsidian"
    cp -r "${OBSIDIAN_CONFIG}" "${OBSIDIAN_NOTES}/.obsidian"
}

function create_note() {
    file_name=$(date "+%Y-%m-%d")_$(echo "$1" | tr ' ' '_')
    mkdir -p "${OBSIDIAN_NOTES}/new"
    file="${OBSIDIAN_NOTES}/new/${file_name}.md"
    touch $file
    switch_to $file
}

function open_note() {
    selected=$(rg --files "$OBSIDIAN_NOTES" | fzf --preview "bat --color=always --style=plain {}")
    if [[ -z "$selected" ]]; then
        exit 0
    fi
    switch_to $selected
}

function start_flush() {
    switch_to "$OBSIDIAN_NOTES/$new_notes_dir/*"
}

function classify() {
    # for file in "$OBSIDIAN_NOTES/$flushed_notes_dir"/*; do
    #     if [[ -f "$file" ]]; then
    #         note_type=$(sed -n 's/^type: //p' "$file")
    #         if [[ -z "$note_type" ]]; then
    #             note_type="uncategorized"
    #         fi
    #         dest_dir="$OBSIDIAN_NOTES/$classified_notes_dir/$note_type"
    #         mkdir -p "$dest_dir"
    #         mv "$file" "$dest_dir/"
    #     fi
    # done

    for file in "$OBSIDIAN_NOTES/$flushed_notes_dir"/*.md; do
        if [[ -f "$file" ]]; then
            # Extract YAML frontmatter block and get the first 'type:'
            note_type=$(awk '/^---$/ {in_yaml = !in_yaml; next} in_yaml && /^type:/ {gsub(/^type:[[:space:]]*/, "", $0); print $0; exit}' "$file" | xargs)
            if [[ -z "$note_type" ]]; then
                note_type="uncategorized"
            fi
            dest_dir="$OBSIDIAN_NOTES/$classified_notes_dir/$note_type"
            mkdir -p "$dest_dir"
            if ! mv -n "$file" "$dest_dir/"; then
                print_error "Error: Failed to move $file to $dest_dir" >&2
            fi
        fi
    done

    print_success "All notes have been classified"
}

if [[ $# -eq 0 ]]; then
    open_note
else
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                run_help
                shift
                ;;
            -f|--flush)
                start_flush
                shift
                ;;
            -c|--class)
                classify
                shift
                ;;
            -C|--create-vault)
                shift
                create_vault "$1"
                shift
                ;;
            -*)
                print_warning "Warning: invalid option $1"
                shift
                ;;
            *)
                create_note "$1"
                shift
                ;;
        esac
    done
fi


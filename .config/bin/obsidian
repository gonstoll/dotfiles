#!/usr/bin/env bash

source "$XDG_CONFIG_HOME/zsh/functions"

new_notes_dir="new"
flushed_notes_dir="flushed"
classified_notes_dir="notes"
vault_name="gonzalo_notes"
OBSIDIAN_CONFIG="${XDG_CONFIG_HOME}/obsidian/"
OBSIDIAN_NOTES="${HOME}/notes/obsidian/${vault_name}"

function switch_to() {
    tmux-sessionizer "$OBSIDIAN_NOTES"
    tmux send-keys -t "$vault_name" "nvim $1" c-M
}

function create_vault() {
    vault_name="$1"
    mkdir -p "${OBSIDIAN_NOTES}/${vault_name}/.obsidian"
    cp -r "${OBSIDIAN_CONFIG}" "${OBSIDIAN_NOTES}/.obsidian"
}

function create_note() {
    file_name=$(date "+%Y-%m-%d")_$(echo "$1" | tr ' ' '_')
    mkdir -p "${OBSIDIAN_NOTES}/new"
    file="${OBSIDIAN_NOTES}/new/${file_name}.md"
    touch $file
    switch_to $file
}

function open_note() {
    selected=$(rg --files "$OBSIDIAN_NOTES" | fzf --preview "bat --color=always --style=plain {}")
    if [[ -z "$selected" ]]; then
        exit 0
    fi
    switch_to $selected
}

function flush() {
    switch_to "$OBSIDIAN_NOTES/$new_notes_dir/*"
}

function classify() {
    # for file in "$OBSIDIAN_NOTES/$flushed_notes_dir"/*; do
    #     if [[ -f "$file" ]]; then
    #         note_type=$(sed -n 's/^type: //p' "$file")
    #         if [[ -z "$note_type" ]]; then
    #             note_type="uncategorized"
    #         fi
    #         dest_dir="$OBSIDIAN_NOTES/$classified_notes_dir/$note_type"
    #         mkdir -p "$dest_dir"
    #         mv "$file" "$dest_dir/"
    #     fi
    # done

    for file in "$OBSIDIAN_NOTES/$flushed_notes_dir"/*.md; do
        if [[ -f "$file" ]]; then
            # Extract YAML frontmatter block and get the first 'type:'
            note_type=$(awk '/^---$/ {in_yaml = !in_yaml; next} in_yaml && /^type:/ {gsub(/^type:[[:space:]]*/, "", $0); print $0; exit}' "$file" | xargs)
            if [[ -z "$note_type" ]]; then
                note_type="uncategorized"
            fi
            dest_dir="$OBSIDIAN_NOTES/$classified_notes_dir/$note_type"
            mkdir -p "$dest_dir"
            if ! mv -n "$file" "$dest_dir/"; then
                echo "Error: Failed to move $file to $dest_dir" >&2
            fi
        fi
    done

    echo "All notes have been classified"
}

if [[ $# -eq 0 ]]; then
    open_note
else
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--flush)
                flush "$OBSIDIAN_NOTES/hubs/*"
                shift
                ;;
            -c|--class)
                classify
                shift
                ;;
            -C|--create-vault)
                shift
                create_vault "$1"
                shift
                ;;
            -*)
                print_warning "Warning: invalid option $1"
                shift
                ;;
            *)
                create_note "$1"
                shift
                ;;
        esac
    done
fi


#!/usr/bin/env bash

download_dir="$HOME/Downloads"
report_dir="$HOME/reports/e2e"
report_file_name="report_$(date +%Y%m%d_%H%M%S).zip"
report_dest="$report_dir/$report_file_name"
run_tests=false

source "$XDG_CONFIG_HOME/zsh/functions"

function run_report() {
    if [[ ! $(find "$report_dir" -maxdepth 1 -name "report*.zip") ]]; then
        print_error "No report files found in $report_dir"
        exit 0
    fi
    print_header "Running reports"
    npx playwright merge-reports --reporter html "$report_dir"
}

for opt in "$@"
do
    case $opt in
        --clean) rm -rf "$report_dir" ;;
        --run) run_tests=true ;;
        -*|--*) print_warning "Warning: invalid option $opt"
    esac
done

if [ ! -d "$report_dir" ]; then
    mkdir -p "$report_dir"
fi

if [ "$run_tests" = true ]; then
    run_report
fi

if [[ ! $(find "$download_dir" -maxdepth 1 -name "report*.zip") ]]; then
    print_warning "No new report file found in downloads"
    run_report
fi

print_header "Moving report to destination directory"
find "$download_dir" -maxdepth 1 -name "report*.zip" -exec mv {} "$report_dir" \;

print_header "Running reports"
npx playwright merge-reports --reporter html "$report_dir"
